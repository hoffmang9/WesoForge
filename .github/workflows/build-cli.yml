name: Build CLI and GUI and test -h

on:
  push:
    branches:
    - main
  release:
    types: [published]
  pull_request:
    branches:
    - '**'

jobs:
  build-and-test:
    name: ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    env:
      # Linux: run AppImages without FUSE (extract and run) so downloaded linuxdeploy works in CI
      APPIMAGE_EXTRACT_AND_RUN: ${{ matrix.os == 'Linux' && '1' || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
            arch: amd64
          - os: macOS
            runner: macos-latest
            arch: arm64
          - os: macOS
            runner: macos-15-intel
            arch: amd64
          - os: Windows
            runner: windows-latest
            arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust (target + registry)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust"

      - name: Setup Node.js (Linux / macOS / Windows, for GUI)
        if: matrix.os == 'Linux' || matrix.os == 'macOS' || matrix.os == 'Windows'
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Prepare Linux
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl build-essential clang gawk pkg-config \
            libgmp-dev libboost-all-dev \
            libgtk-3-dev libsoup-3.0-dev libwebkit2gtk-4.1-dev librsvg2-dev

      - name: Prepare macOS
        if: matrix.os == 'macOS'
        run: |
          brew install pkg-config gmp

      - name: Prepare macOS Intel (Boost)
        if: matrix.runner == 'macos-15-intel'
        run: brew install boost

      - name: Patch chiavdf for GMP 6.3 (macOS Intel)
        if: matrix.runner == 'macos-15-intel'
        run: git -C chiavdf apply "$GITHUB_WORKSPACE/patches/chiavdf-gmp63-mpz-macro.patch"

      - name: Prepare Windows (MPIR and LLVM)
        if: matrix.os == 'Windows'
        run: |
          git clone https://github.com/Chia-Network/mpir_gc_x64.git chiavdf/mpir_gc_x64
          winget install LLVM.LLVM --accept-package-agreements --accept-source-agreements --silent

      - name: Set Windows PATH for LLVM
        if: matrix.os == 'Windows'
        run: |
          echo "$env:ProgramFiles\LLVM\bin" | Out-File -Append -FilePath $env:GITHUB_PATH
          echo "PATH=$env:ProgramFiles\LLVM\bin;$env:PATH" >> $env:GITHUB_ENV

      - name: Determine version (Linux / macOS)
        if: matrix.os != 'Windows'
        run: |
          VERSION="$(python3 - <<'PY'
          import tomllib
          with open("Cargo.toml", "rb") as f:
            cargo = tomllib.load(f)
          print(cargo["workspace"]["package"]["version"])
          PY
          )"
          if [ -z "${VERSION:-}" ]; then
            echo "Failed to determine version from Cargo.toml" >&2
            exit 1
          fi
          echo "WESOFORGE_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Determine version (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          $inPkg = $false
          $version = $null
          foreach ($line in Get-Content -LiteralPath "Cargo.toml") {
            if ($line -match '^\[workspace\.package\]') {
              $inPkg = $true
              continue
            }
            if ($inPkg -and $line -match '^\[') {
              $inPkg = $false
            }
            if ($inPkg -and $line -match '^version\s*=\s*"([^"]+)"') {
              $version = $Matches[1]
              break
            }
          }
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Failed to determine version from Cargo.toml"
          }
          Add-Content -Path $env:GITHUB_ENV -Value "WESOFORGE_VERSION=$version"

      - name: Install pnpm and Tauri CLI, then build Rust (CLI + GUI once)
        shell: bash
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          cargo install tauri-cli
          pnpm -C ui install
          # Build CLI only here; GUI is built by cargo tauri build so its binary has __TAURI_BUNDLE_TYPE
          cargo build --release -p bbr-client --features prod-backend
          case "$(uname -s)" in
            Linux) (cd crates/client-gui && export NO_STRIP=1 && cargo tauri build --features prod-backend --bundles appimage) ;;
            Darwin) (cd crates/client-gui && cargo tauri build --features prod-backend --bundles dmg) ;;
            *) (cd crates/client-gui && cargo tauri build --features prod-backend) ;;
          esac

      - name: Package CLI (Linux / macOS)
        if: matrix.os != 'Windows'
        env:
          BBR_SKIP_CARGO_BUILD: 1
        run: ./build-cli.sh

      - name: Package CLI (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        env:
          BBR_SKIP_CARGO_BUILD: 1
        run: ./build-cli.ps1

      - name: Test -h output (Linux / macOS)
        if: matrix.os != 'Windows'
        run: |
          BIN="target/release/wesoforge"
          [ -f "$BIN" ] || { echo "Binary not found: $BIN"; exit 1; }
          OUTPUT="$("$BIN" -h 2>&1)"
          echo "$OUTPUT"
          echo "---"
          echo "$OUTPUT" | grep -q "WesoForge" || { echo "Expected -h output to contain 'WesoForge'"; exit 1; }
          echo "$OUTPUT" | grep -q "Usage" || { echo "Expected -h output to contain 'Usage'"; exit 1; }
          echo "$OUTPUT" | grep -q "compact proof worker" || { echo "Expected -h output to contain 'compact proof worker'"; exit 1; }
          echo "Help output assertions passed."

      - name: Test -h output (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # Run from dist/ where MPIR DLLs are; target\release\wesoforge.exe would fail to load without them
          $distExe = Get-ChildItem -Path dist -Filter "WesoForge-cli_*.exe" | Select-Object -First 1
          if (-not $distExe) { throw "Binary not found in dist/" }
          $bin = $distExe.FullName
          # Clap prints -h to stderr; capture both streams so we get the full help text
          $outFile = "help-stdout.txt"
          $errFile = "help-stderr.txt"
          $null = Start-Process -FilePath $bin -ArgumentList "-h" -NoNewWindow -Wait -PassThru -RedirectStandardOutput $outFile -RedirectStandardError $errFile -WorkingDirectory (Split-Path $bin)
          $output = (Get-Content $outFile -Raw) + (Get-Content $errFile -Raw)
          Write-Host $output
          Write-Host "---"
          if ($output -notmatch "WesoForge") { throw "Expected -h output to contain 'WesoForge'" }
          if ($output -notmatch "Usage") { throw "Expected -h output to contain 'Usage'" }
          if ($output -notmatch "compact proof worker") { throw "Expected -h output to contain 'compact proof worker'" }
          Write-Host "Help output assertions passed."

      - name: Determine version (Linux / macOS)
        if: matrix.os != 'Windows'
        run: |
          VERSION="$(python3 - <<'PY'
          import tomllib
          with open("Cargo.toml", "rb") as f:
            cargo = tomllib.load(f)
          print(cargo["workspace"]["package"]["version"])
          PY
          )"
          if [ -z "${VERSION:-}" ]; then
            echo "Failed to determine version from Cargo.toml" >&2
            exit 1
          fi
          echo "WESOFORGE_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Determine version (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          $inPkg = $false
          $version = $null
          foreach ($line in Get-Content -LiteralPath "Cargo.toml") {
            if ($line -match '^\[workspace\.package\]') {
              $inPkg = $true
              continue
            }
            if ($inPkg -and $line -match '^\[') {
              $inPkg = $false
            }
            if ($inPkg -and $line -match '^version\s*=\s*"([^"]+)"') {
              $version = $Matches[1]
              break
            }
          }
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Failed to determine version from Cargo.toml"
          }
          Add-Content -Path $env:GITHUB_ENV -Value "WESOFORGE_VERSION=$version"

      - name: Upload dist artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: WesoForge_${{ matrix.os }}_${{ env.WESOFORGE_VERSION }}_${{ matrix.arch }}
          path: dist/
          if-no-files-found: warn
